<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laughing All the Way</title>

  <meta name="theme-color" content="#d93823" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />

  <!-- iOS Add to Home Screen support -->
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root {
      --bg: #d93823;
      --ink: #1f2a35;
      --card: #ffffff;
      --shadow: rgba(0,0,0,0.15);
      --line: #e5ecf0;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--ink);
    }

    header { padding: 14px 16px 4px; text-align: center; }
    .brand {
      width: 320px; max-width: 78vw; height: auto;
      display: inline-block; border-radius: 18px;
      box-shadow: 0 6px 18px var(--shadow);
      background: transparent;
    }

    .controls { display: flex; gap: 10px; justify-content: center; margin: 8px 0; }
    .pill {
      background: var(--card); border: 1px solid var(--line);
      padding: 8px 12px; border-radius: 999px;
      box-shadow: 0 2px 6px var(--shadow);
      font-size: .9rem; cursor: pointer;
    }
    #installBtn { display: inline-block; }

    /* helper banner */
    #installHelp { display:none; margin:8px auto 0; max-width:820px; }
    #installHelp > div {
      background:#fff; border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; box-shadow:0 2px 6px rgba(0,0,0,.08);
      font-size:.92rem; line-height:1.3; text-align:center;
    }

    .grid {
      display: grid; grid-template-columns: repeat(5, 1fr);
      gap: 12px; padding: 16px; max-width: 820px; margin: 10px auto 80px;
    }
    .tile {
      aspect-ratio: 1 / 1;
      background: var(--card); color: #2b4a5e;
      border-radius: 16px; display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 1.4rem; box-shadow: 0 3px 10px var(--shadow);
      border: 1px solid var(--line); cursor: pointer; position: relative; user-select: none;
    }
    .tile.locked { cursor: default; color: #a6b7c0; }
    .tile.opened { outline: 3px solid rgba(255,255,255,.65); }

    /* Fullscreen viewer */
    .viewer {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: none; align-items: center; justify-content: center; padding: 16px;
      z-index: 3;
    }
    .viewer.open { display: flex; }
    .card {
      width: min(760px, 92vw); max-height: 86vh; overflow: auto;
      background: var(--card); border-radius: 18px; box-shadow: 0 12px 40px rgba(0,0,0,.35);
      border: 1px solid var(--line); padding: 18px 18px 22px;
      transform: translateY(8px); animation: pop .18s ease-out both;
    }
    @keyframes pop { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .card h2 { margin: 0 0 6px; font-size: 1.15rem; letter-spacing: .3px; color: #2b4a5e; }
    .prompt { font-size: 1rem; line-height: 1.45; color: var(--ink); }
    .close {
      position: sticky; top: -8px; float: right;
      background: #f1f5f9; border: 0; border-radius: 10px; padding: 8px 10px; cursor: pointer;
      font-weight: 700; color: #2b4a5e; box-shadow: 0 2px 6px var(--shadow);
    }

    /* Snow */
    #snow { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    main { position: relative; z-index: 1; }

    footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(255,255,255,.88); backdrop-filter: blur(6px);
      border-top: 1px solid var(--line); padding: 10px 14px; text-align: center; font-size: .85rem;
    }

    @media (max-width: 520px) {
      .grid { grid-template-columns: repeat(4, 1fr); }
    }
  </style>
</head>
<body>
  <canvas id="snow"></canvas>

  <header>
    <!-- Your uploaded graphic name should match the file in the repo -->
    <img class="brand" src="./LATWlogo.png" alt="Laughing All the Way — Advent Calendar from Playful Heart Parenting" />
    <div class="controls">
      <button class="pill" id="installBtn" hidden>Install</button>
    </div>
    <div id="installHelp">
      <div><span id="installHelpText"></span></div>
    </div>
  </header>

  <main>
    <section class="grid" id="grid"></section>
  </main>

  <footer>Tap a numbered square. The prompt opens full screen for easy reading.</footer>

  <!-- Fullscreen Viewer -->
  <div class="viewer" id="viewer" aria-modal="true" role="dialog">
    <div class="card" id="card">
      <button class="close" id="closeBtn">Close</button>
      <h2 id="cardTitle"></h2>
      <div class="prompt" id="cardBody"></div>
    </div>
  </div>

  <script>
  // Content
  const IDEAS = [
    "Day 1 — Serious Santa: Put on your most serious face and try not to laugh while saying ‘Ho! Ho! Ho!’ <em>For littler elves: big ‘Ho! Ho! Ho!’s and funny faces.</em>",
    "Day 2 — Reverse Christmas Charades: Give step-by-step instructions to make someone act it out, then guess. <em>For littler elves: do simple charades with sounds.</em>",
    "Day 3 — Very Merry Ventriloquism: Say holiday phrases without moving your lips. <em>For littler elves: use a puppet or stuffed animal voice.</em>",
    "Day 4 — Dashing Through the Doodles: Finger-draw a holiday picture to guess. <em>For littler elves: offer two choices or draw on paper.</em>",
    "Day 5 — Jingle Jargon: Speak in elf gibberish and translate. <em>For littler elves: try short silly giggles and gibberish.</em>",
    "Day 6 — Holly Jolly Handshake: Invent a handshake with 2–3 moves. <em>For littler elves: keep moves easy with sound effects.</em>",
    "Day 7 — Hot Stocking: Hot-potato with balled socks. Loser does a silly challenge. <em>For littler elves: pass a plush slowly. Skip the challenge if needed.</em>",
    "Day 8 — Tinsel Twisters: Try “Santa’s short suit shrunk,” etc. five times fast. <em>For littler elves: go slowly and enjoy the sounds.</em>",
    "Day 9 — Winter Would You Rather: Ask holiday would-you-rather questions. <em>For littler elves: use very simple either-or.</em>",
    "Day 10 — Merry Mad Libs: Fill in the blanks for a goofy story. <em>For littler elves: you suggest easy words like color or snack.</em>",
    "Day 11 — Strike a Jolly Pose: Lights off. Pose on a prompt. Lights on. Pick the funniest. <em>For littler elves: skip lights. Just pose together.</em>",
    "Day 12 — Kooky Carols: Sing alternating words. Try syllables if brave. <em>For littler elves: sing together. Let them lead a word.</em>",
    "Day 13 — Christmas Choreographer: Make moves. Others copy. Build a family dance. <em>For littler elves: copy their moves or let them teach.</em>",
    "Day 14 — Hot Cocoa Freeze Challenge: Pretend to sip then freeze your face. <em>For littler elves: you freeze and make them giggle.</em>",
    "Day 15 — Truth or Merry Mischief: Answer a truth or do a harmless dare. <em>For littler elves: tiny truths. Dares like clap or spin.</em>",
    "Day 16 — Silent Night Singing: Lip-sync a carol while others guess. <em>For littler elves: hum or tap the rhythm.</em>",
    "Day 17 — Santa Says: Simon Says with Santa. Keep everyone playing. <em>For littler elves: no out. Just play.</em>",
    "Day 18 — Ice Powers: Kids shout Freeze then Unfreeze and run to base. <em>For littler elves: try freeze dance first.</em>",
    "Day 19 — Impromptu Nutcracker: Dance to The Nutcracker and capture it. <em>For littler elves: hold hands and spin.</em>",
    "Day 20 — Holiday Mind Meld: 1 2 3 say the same holiday word together. <em>For littler elves: be a mirror. Match faces and sounds.</em>",
    "Day 21 — 10 Second Shenanigans: Act a quick holiday scenario in ten seconds. <em>For littler elves: you perform. They pick or join.</em>",
    "Day 22 — The Jolly Storyteller: Build a story sentence by sentence. <em>For littler elves: pause and point for a key word.</em>",
    "Day 23 — Reindeer Hop Challenge: Hop like a reindeer for one minute. <em>For littler elves: jump or stomp or clap.</em>",
    "Day 24 — Jingle Jangle Jam: Make up a song at the same time. <em>For littler elves: simple tune with silly wrong words.</em>",
    "Day 25 — That’s a Wrap: Wrap feet or a blanket present. Over react as you unwrap. <em>For littler elves: wrap a blanket gift. Celebrate them.</em>"
  ];

  // Date logic
  const today = new Date();
  const currentDay = (today.getMonth() === 11) ? today.getDate() : 1;

  const grid = document.getElementById('grid');
  const viewer = document.getElementById('viewer');
  const cardTitle = document.getElementById('cardTitle');
  const cardBody  = document.getElementById('cardBody');
  const closeBtn  = document.getElementById('closeBtn');

  // State
  const stateKey = 'latw_opened_v2';
  const opened = new Set(JSON.parse(localStorage.getItem(stateKey) || '[]'));
  function saveState(){ localStorage.setItem(stateKey, JSON.stringify([...opened])); }

  function makeTile(i){
    const day = i + 1;
    const el = document.createElement('button');
    el.className = 'tile';
    el.type = 'button';
    el.textContent = day;

    const canOpen = (day <= currentDay) || opened.has(day);
    if (!canOpen) el.classList.add('locked');
    if (opened.has(day)) el.classList.add('opened');

    el.addEventListener('click', () => {
      if (!canOpen) return;
      if (!opened.has(day)) { opened.add(day); saveState(); el.classList.add('opened'); }
      openViewer(day, IDEAS[i]);
      history.replaceState(null, '', `?day=${day}`);
    });
    return el;
  }

  function renderGrid(){
    grid.innerHTML = '';
    for (let i=0; i<25; i++) grid.appendChild(makeTile(i));
  }

  function openViewer(day, html){
    cardTitle.textContent = `Day ${day}`;
    cardBody.innerHTML = html;
    viewer.classList.add('open');
  }
  function closeViewer(){
    viewer.classList.remove('open');
    if (location.search.includes('day=')) history.replaceState(null,'', location.pathname);
  }
  viewer.addEventListener('click', (e) => { if (e.target === viewer) closeViewer(); });
  closeBtn.addEventListener('click', closeViewer);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeViewer(); });

  // Deep link
  (function deep(){
    const p = new URLSearchParams(location.search);
    let d = p.get('day');
    if (d === 'today') d = String(currentDay);
    const n = Number(d);
    if (n >= 1 && n <= 25) openViewer(n, IDEAS[n-1]);
  })();

  renderGrid();

  // Snowfall
  const canvas = document.getElementById('snow');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', resize); resize();
  const flakes = Array.from({length: Math.min(200, Math.floor(innerWidth/5))},
    () => ({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: Math.random()*2+0.7, s: Math.random()*0.7+0.2 })
  );
  (function snow(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    for (const f of flakes){
      ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
      f.y += f.s; f.x += Math.sin(f.y*0.01);
      if (f.y > canvas.height) { f.y = -6; f.x = Math.random()*canvas.width; }
    }
    requestAnimationFrame(snow);
  })();

  // Install UI logic and helper banner
  const isStandalone =
    window.matchMedia('(display-mode: standalone)').matches ||
    window.navigator.standalone === true;

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isSafari = /^((?!chrome|android|crios|fxios|edgios).)*safari/i.test(navigator.userAgent);
  const isAndroid = /Android/i.test(navigator.userAgent);

  const helpWrap = document.getElementById('installHelp');
  const helpText = document.getElementById('installHelpText');
  const installBtn = document.getElementById('installBtn');

  if (isStandalone) {
    if (installBtn) installBtn.hidden = true;
    if (helpWrap) helpWrap.style.display = 'none';
  }

  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (!isStandalone && installBtn) installBtn.hidden = false;
    if (helpWrap) helpWrap.style.display = 'none';
  });

  if (installBtn) {
    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      installBtn.hidden = true;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });
  }

  window.addEventListener('load', () => {
    if (isStandalone) return;
    const noPromptSupport = !('onbeforeinstallprompt' in window);
    if (noPromptSupport) {
      if (isIOS && isSafari) {
        helpText.textContent = 'To install on iPhone. Tap Share, then Add to Home Screen.';
        helpWrap.style.display = 'block';
      } else if (isAndroid) {
        helpText.textContent = 'To install on Android. Open in Chrome to see the Install button or menu Add to Home screen.';
        helpWrap.style.display = 'block';
      } else {
        helpText.textContent = 'To install. Use Chrome or Edge Install. On iPhone use Share then Add to Home Screen.';
        helpWrap.style.display = 'block';
      }
    }
  });

  // Register Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }
  </script>
</body>
</html>

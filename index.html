<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laughing All the Way</title>

  <meta name="theme-color" content="#d93823" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />

  <!-- iOS Add to Home Screen support -->
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Rounded, bubbly font -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#d93823;
      --ink:#1f2a35;
      --card:#ffffff;
      --shadow:rgba(0,0,0,0.15);
      --line:#e5ecf0;
      --teal:#237e6b;
    }

    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    #appWrap{flex:1}
    #appWrap.blur{filter:blur(4px) saturate(.9);pointer-events:none;user-select:none}

    header{text-align:center;padding:14px 16px 4px;}
    .brand{
      width:320px;max-width:78vw;height:auto;
      display:inline-block;border-radius:18px;
      box-shadow:0 6px 18px var(--shadow);
      background:transparent;
      position:relative;z-index:3; /* above snow */
    }

    .controls{display:flex;gap:10px;justify-content:center;margin:8px 0}
    .pill{
      background:var(--card);border:1px solid var(--line);
      padding:8px 12px;border-radius:999px;
      box-shadow:0 2px 6px var(--shadow);
      font-size:.9rem;cursor:pointer;
    }
    /* start hidden; we only show it when Chrome fires the event */
    #installBtn{display:none}

    #installHelp{display:none;margin:8px auto 0;max-width:820px;text-align:center;}
    #installHelp>div{
      background:#fff;border:1px solid var(--line);border-radius:12px;
      padding:10px 12px;box-shadow:0 2px 6px rgba(0,0,0,.08);
      font-size:.92rem;line-height:1.3;
      font-family:'Baloo 2',system-ui;
    }
    #closeInstallHelp{
      margin-top:6px;
      background:#237e6b;color:#fff;border:0;border-radius:999px;
      padding:6px 14px;font-family:'Baloo 2',system-ui;font-weight:700;font-size:.85rem;
      cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);
      transition:transform .1s ease, box-shadow .1s ease;
    }
    #closeInstallHelp:hover{transform:translateY(-1px);box-shadow:0 3px 10px rgba(0,0,0,.25);}

    .grid{
      display:grid;grid-template-columns:repeat(5,1fr);
      gap:12px;padding:16px;max-width:820px;margin:10px auto 20px;
      position:relative;z-index:2;
    }

    /* Gift-box style tiles (with lid element inside) */
    .tile{
      aspect-ratio:1/1;background:var(--card);color:var(--teal);
      border-radius:22px;border:4px solid var(--teal);
      display:flex;align-items:center;justify-content:center;
      font-family:'Baloo 2',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-weight:700;font-size:2.3rem;
      box-shadow:0 3px 10px var(--shadow);
      cursor:pointer;position:relative;user-select:none;
      transition:transform .1s ease, box-shadow .1s ease;
      overflow:visible;
    }
    .tile:hover{transform:translateY(-2px);box-shadow:0 5px 14px var(--shadow)}
    .tile.opened{outline:3px solid rgba(35,126,107,.35)}
    /* Lid inside the tile (we animate this) */
    .tile .lid{
      position:absolute;top:0;left:0;right:0;height:20%;
      border-bottom:4px solid var(--teal);
      border-top-left-radius:18px;border-top-right-radius:18px;
      background:transparent;z-index:2;transform-origin:50% 0%;
      transition:transform .22s ease, filter .22s ease;
    }
    .tile:active .lid{transform:translateY(-2px);}
    .tile .num{position:relative;z-index:1;}

    /* Ghost that animates to fullscreen */
    .open-ghost{
      position:fixed;z-index:6;border-radius:22px;background:var(--card);
      border:4px solid var(--teal);box-shadow:0 12px 30px rgba(0,0,0,.25);
      will-change:transform,width,height,border-radius,opacity;overflow:hidden;
    }
    .open-ghost .lid{
      position:absolute;top:0;left:0;right:0;height:20%;
      border-bottom:4px solid var(--teal);
      border-top-left-radius:18px;border-top-right-radius:18px;
      background:transparent;transform-origin:50% 0%;
    }
    .open-ghost .num{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-family:'Baloo 2',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-weight:700;font-size:2.3rem;color:var(--teal);z-index:1;
    }
    .open-ghost.fade-num .num{opacity:0;transition:opacity .12s ease;}
    .open-ghost.lid-up .lid{transform:translateY(-18%);filter:drop-shadow(0 6px 6px rgba(0,0,0,.15));}

    /* Viewer */
    .viewer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:5}
    .viewer.open{display:flex}
    .card{
      width:min(760px,92vw);max-height:86vh;overflow:auto;background:var(--card);
      border-radius:26px;box-shadow:0 8px 30px rgba(0,0,0,.25);
      border:2px solid rgba(35,126,107,.15);padding:22px 22px 26px;
      transform:translateY(8px);animation:pop .18s ease-out both;
    }
    @keyframes pop{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .card h2{margin:0 0 8px;font-size:1.35rem;letter-spacing:.3px;color:var(--teal);font-family:'Baloo 2',system-ui;font-weight:700}
    .prompt{font-size:1.05rem;line-height:1.5;color:var(--ink);font-family:'Baloo 2',system-ui;}
    .prompt em{color:var(--teal);font-style:normal;font-weight:600}
    .close{position:sticky;top:-8px;float:right;background:#f1f5f9;border:0;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700;color:#2b4a5e;box-shadow:0 2px 6px var(--shadow)}

    /* Snow behind everything */
    #snow{position:fixed;inset:0;pointer-events:none;z-index:0}
    header,main,footer,#appWrap{position:relative;z-index:2}

    footer{
      background:rgba(255,255,255,.92);
      border-top:1px solid var(--line);
      padding:12px 14px 18px;
      text-align:center;
      font-size:.78rem;
      line-height:1.25rem;
    }

    /* Confetti canvas (temporary, created in JS). Higher z than ghost for sparkle) */
    .confetti-layer{
      position:fixed;inset:0;pointer-events:none;z-index:7;
    }

    /* Accessibility: reduce motion */
    @media (prefers-reduced-motion: reduce) {
      .tile .lid, .open-ghost, .open-ghost .lid { transition: none !important; }
    }

    @media (max-width:620px){.grid{grid-template-columns:repeat(4,1fr)}}
  </style>
</head>
<body>
  <canvas id="snow"></canvas>

  <!-- Welcome / Agreement overlay -->
  <div id="welcome" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:8;">
    <div style="background:rgba(0,0,0,.45);position:absolute;inset:0;"></div>
    <div style="position:relative;background:#fff;border:1px solid #e5ecf0;border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:22px;max-width:580px;margin:20px;">
      <h2 style="margin:0 0 8px;font-family:'Baloo 2',system-ui;font-size:1.25rem;color:#237e6b;">Before you enter</h2>
      <p style="margin:6px 0 14px;font-size:.98rem;line-height:1.45;">
        This app is only for those who purchased from Playful Heart Parenting. Thank you for supporting this work.
      </p>
      <label style="display:flex;align-items:center;gap:10px;margin:2px 0 14px;font-size:.95rem;">
        <input id="agreeChk" type="checkbox" />
        <span>I agree to keep this link private and not share it publicly.</span>
      </label>
      <button id="agreeBtn" disabled
        style="background:#237e6b;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:not-allowed;box-shadow:0 2px 6px rgba(0,0,0,.15);font-family:'Baloo 2',system-ui;">
        Enter
      </button>
    </div>
  </div>

  <div id="appWrap" class="blur">
    <header>
      <img class="brand" src="./LATWlogo.png" alt="Laughing All the Way — Advent Calendar from Playful Heart Parenting" />
      <div class="controls">
        <button class="pill" id="installBtn">Install</button>
      </div>

      <div id="installHelp">
        <div>
          <span id="installHelpText"></span>
          <br />
          <button id="closeInstallHelp">Close</button>
        </div>
      </div>
    </header>

    <main>
      <section class="grid" id="grid"></section>
    </main>
  </div>

  <footer>
    © 2025 Mia Wisinski, Playful Heart Parenting. This app is for personal use only by those who have purchased access from Playful Heart Parenting. Please do not share this link publicly or distribute without explicit permission.
  </footer>

  <!-- Fullscreen Viewer -->
  <div class="viewer" id="viewer" aria-modal="true" role="dialog">
    <div class="card" id="card">
      <button class="close" id="closeBtn">Close</button>
      <h2 id="cardTitle"></h2>
      <div class="prompt" id="cardBody"></div>
    </div>
  </div>

  <script>
  // ---- Content (replace with your real day content) ----
  const IDEAS = Array.from({length:25},(_,i)=>`Day ${i+1} — Placeholder content here.`);

  // ---- Build tiles with lid & number ----
  const grid=document.getElementById('grid');
  function makeTile(i){
    const day=i+1;
    const el=document.createElement('button');
    el.className='tile';
    el.type='button';
    el.innerHTML = `<span class="lid" aria-hidden="true"></span><span class="num">${day}</span>`;
    el.addEventListener('click',()=>animateOpen(el, day, IDEAS[i]));
    return el;
  }
  function renderGrid(){grid.innerHTML='';for(let i=0;i<25;i++)grid.appendChild(makeTile(i));}
  renderGrid();

  // ---- Viewer ----
  const viewer=document.getElementById('viewer');
  const cardTitle=document.getElementById('cardTitle');
  const cardBody=document.getElementById('cardBody');
  const closeBtn=document.getElementById('closeBtn');
  function openViewer(day,html){cardTitle.textContent=`Day ${day}`;cardBody.innerHTML=html;viewer.classList.add('open');}
  function closeViewer(){viewer.classList.remove('open');}
  viewer.addEventListener('click',e=>{if(e.target===viewer)closeViewer();});
  closeBtn.addEventListener('click',closeViewer);
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeViewer();});

  // ---- Welcome / Agreement ----
  const ACK_KEY='latw_ack_v1';
  const appWrap=document.getElementById('appWrap');
  const welcome=document.getElementById('welcome');
  const agreeChk=document.getElementById('agreeChk');
  const agreeBtn=document.getElementById('agreeBtn');
  function showWelcome(){appWrap.classList.add('blur');welcome.style.display='flex';document.body.style.overflow='hidden';}
  function hideWelcome(){appWrap.classList.remove('blur');welcome.style.display='none';document.body.style.overflow='';}
  if(!localStorage.getItem(ACK_KEY))showWelcome();
  agreeChk.addEventListener('change',()=>{agreeBtn.disabled=!agreeChk.checked;agreeBtn.style.cursor=agreeChk.checked?'pointer':'not-allowed';});
  agreeBtn.addEventListener('click',()=>{if(!agreeChk.checked)return;localStorage.setItem(ACK_KEY,'yes');hideWelcome();});

  // ---- Snowfall ----
  const canvas=document.getElementById('snow'),ctx=canvas.getContext('2d');
  function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
  addEventListener('resize',resize);resize();
  const flakes=Array.from({length:Math.min(200,Math.floor(innerWidth/5))},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*2+0.7,s:Math.random()*0.7+0.2}));
  (function snow(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='rgba(255,255,255,0.95)';for(const f of flakes){ctx.beginPath();ctx.arc(f.x,f.y,f.r,0,Math.PI*2);ctx.fill();f.y+=f.s;f.x+=Math.sin(f.y*0.01);if(f.y>canvas.height){f.y=-6;f.x=Math.random()*canvas.width;}}requestAnimationFrame(snow);})();

  // ---- Install UI ----
  const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone===true;
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||('ontouchend'in document&&navigator.userAgent.includes('Mac'));
  const isSafari=/^((?!chrome|android|crios|fxios|edgios).)*safari/i.test(navigator.userAgent);
  const isAndroid=/Android/i.test(navigator.userAgent);

  const helpWrap=document.getElementById('installHelp');
  const helpText=document.getElementById('installHelpText');
  const closeInstallHelp=document.getElementById('closeInstallHelp');
  const installBtn=document.getElementById('installBtn');
  const CLOSE_KEY='latw_installHelp_closed';

  if(localStorage.getItem(CLOSE_KEY)){helpWrap.style.display='none';}
  if(isIOS){installBtn.remove();}

  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e=>{
    e.preventDefault();
    deferredPrompt=e;
    if(!isStandalone && !isIOS){installBtn.style.display='inline-block';}
    if(helpWrap)helpWrap.style.display='none';
  });

  if(installBtn){
    installBtn.addEventListener('click',async()=>{
      if(!deferredPrompt)return;
      installBtn.style.display='none';
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null;
    });
  }

  window.addEventListener('load',()=>{
    if(isStandalone)return;
    const noPromptSupport=!('onbeforeinstallprompt'in window);
    if(noPromptSupport){
      if(isIOS){
        helpText.textContent='To install on iPhone: tap Share → Add to Home Screen.';
        helpWrap.style.display=localStorage.getItem(CLOSE_KEY)?'none':'block';
      }else if(isAndroid){
        helpText.textContent='To install on Android: open in Chrome → menu → Add to Home screen.';
        helpWrap.style.display=localStorage.getItem(CLOSE_KEY)?'none':'block';
      }else{
        helpText.textContent='To install: use Chrome or Edge Install button, or on iPhone use Share → Add to Home Screen.';
        helpWrap.style.display=localStorage.getItem(CLOSE_KEY)?'none':'block';
      }
    }
  });

  if(closeInstallHelp){
    closeInstallHelp.addEventListener('click',()=>{
      helpWrap.style.display='none';
      localStorage.setItem(CLOSE_KEY,'true');
    });
  }

  // ---- Lid lift + zoom animation, with confetti on Day 25 only ----
  function animateOpen(tileEl, day, html) {
    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduce) { openViewer(day, html); return; }

    const rect = tileEl.getBoundingClientRect();
    const ghost = document.createElement('div');
    ghost.className = 'open-ghost';
    ghost.style.width = rect.width + 'px';
    ghost.style.height = rect.height + 'px';
    ghost.style.left = rect.left + 'px';
    ghost.style.top = rect.top + 'px';

    const lid = document.createElement('span');
    lid.className = 'lid';
    const num = document.createElement('span');
    num.className = 'num';
    num.textContent = tileEl.querySelector('.num').textContent;
    ghost.appendChild(lid); ghost.appendChild(num);
    document.body.appendChild(ghost);

    // Optional confetti burst for Day 25
    if (day === 25) {
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height*0.1; // at the lid
      confettiBurst(cx, cy);
    }

    // Target card size/position
    const vw = Math.min(760, window.innerWidth * 0.92);
    const vh = Math.min(window.innerHeight * 0.86, 560);
    const targetW = vw;
    const targetH = Math.min(vh, Math.max(rect.height*2.2, 340));
    const targetLeft = (window.innerWidth - targetW) / 2;
    const targetTop  = (window.innerHeight - targetH) / 2;

    requestAnimationFrame(()=>{ ghost.classList.add('lid-up'); });

    const duration = 260;
    const ease = 'cubic-bezier(.2,.8,.2,1)';
    ghost.animate([
      { left: rect.left + 'px', top: rect.top + 'px', width: rect.width + 'px', height: rect.height + 'px', borderRadius: '22px' },
      { left: targetLeft + 'px', top: targetTop + 'px', width: targetW + 'px', height: targetH + 'px', borderRadius: '26px' }
    ], { duration, easing: ease, fill: 'forwards' });

    setTimeout(()=>{
      ghost.classList.add('fade-num');
      openViewer(day, html);
      setTimeout(()=> ghost.remove(), 140);
    }, duration + 80);
  }

  // ---- Lightweight confetti (canvas) for Day 25 only ----
  function confettiBurst(x, y) {
    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduce) return;

    const layer = document.createElement('canvas');
    layer.className = 'confetti-layer';
    layer.width = window.innerWidth;
    layer.height = window.innerHeight;
    document.body.appendChild(layer);
    const ctx = layer.getContext('2d');

    const colors = ['#ffffff', '#d93823', '#237e6b', '#f7c948']; // white, red, teal, gold
    const N = 120;
    const parts = [];
    for (let i=0;i<N;i++){
      const angle = (Math.random()*Math.PI - Math.PI/2) + (i%2===0? -0.3:0.3);
      const speed = 4 + Math.random()*4;
      parts.push({
        x, y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed - 2,
        g: 0.18 + Math.random()*0.08,
        life: 900 + Math.random()*400,
        size: 3 + Math.random()*4,
        color: colors[(Math.random()*colors.length)|0],
        rot: Math.random()*Math.PI, vr: (Math.random()-0.5)*0.2,
        shape: Math.random() < 0.6 ? 'rect' : 'circle'
      });
    }

    let start = null;
    function tick(ts){
      if (!start) start = ts;
      const dt = ts - start;
      ctx.clearRect(0,0,layer.width,layer.height);
      for (const p of parts){
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.color;
        if (p.shape === 'rect'){
          ctx.fillRect(-p.size, -p.size, p.size*2, p.size*1.2);
        } else {
          ctx.beginPath();
          ctx.arc(0,0,p.size,0,Math.PI*2);
          ctx.fill();
        }
        ctx.restore();
      }
      if (dt < 1200) {
        requestAnimationFrame(tick);
      } else {
        layer.remove();
      }
    }
    requestAnimationFrame(tick);
  }

  // ---- Service Worker ----
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));
  }
  </script>
</body>
</html>
